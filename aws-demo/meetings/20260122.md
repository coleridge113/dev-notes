# MQTT Authentication
## X.509 Certificates
    Certificates can be created via the console and "embedded" in the client.

## AWS Cognito
    If Cognito is used, using its identity pools to manage user authentication. Credentials received via Cognito are valid for creating the MQTT client

## Custom Authorizer
    AWS allows custom authorization. These credentials can be used to build the MQTT client
    
> [!ABSTRACT] Creating an IOT Thing (Device Shadow) is NOT necessary to create the MQTT client.
    Having an IOT Thing does give us more context about the device such as employee IDs and properties like battery level, vehicle type, etc.


# Architecture

**Old:**
RS (IOT MQTT) 
    -> IOT Core -> IOT Rule 
        -> Lambda (custom property) 
            -> Location Services (Tracker / Geofence) 
                -> EventBridge -> Lambda -> API Endpoint


**New:**
RS (IOT MQTT) 
    -> IOT Core -> IOT Rule 
        -> Lambda (custom property)
            -> AWS Location Services (Tracker / Geofence) 
                -> EventBridge -> API Destination

**Proposed:**
RS (IOT MQTT)
    -> IOT Core -> IOT Rule 
        -> x (SNS?) <- TD
        
        -> AWS Location Services (Tracker / Geofence) 

Options:
- x: SNS
- x: MQTT
- x: AppSync 


# Process

> [!NOTE] MQTT Payload
```
Topic: "tracker/<deivceId>joborder/idadfas/update"
    {
      "latitude": 14.5516247,
      "longitude": 121.0311605,
      "sequence": 0,
      "timestamp": 1769059293757,
      "deviceId": "Device-1",
      "jobOrderId": "JobOrder-1"
    }
```

> [!NOTE] IOT Rule retrieves the message using an SQL statement
`SELECT * FROM "tracker/+/update"`

| sequence | timestamp | deviceId | jobOrderId | latitude | longitude |
|----------|-----------|----------|------------|----------|-----------|
| 0        | 1769059293757 | Device-1 | JobOrder-1 | 14.5516247 | 121.0311605 |


> [!WARNING] Once a message is processed by the rule, it is gone forever.

> [!NOTE] Lambda transformation
```
{
    TrackerName: "MetromartDemoTracker",
    Updates: [
        {
            DeviceId: deviceId,
            Position: [longitude, latitude],
            SampleTime: new Date(timestamp),
            PositionProperties: {
                "jobOrderId": jobOrderId,
            }
        }
    ]
}
```

> [!NOTE] Location Services: Tracker creates an event for every VALID update
    MetromartDemoTracker currently filters updates based on a 30-meter interval
    Every update within 30 meters from the last location update is rejected.

    Every valid update creates an event.
```
    {
      "EventType": "UPDATE",
      "TrackerName": "MetromartDemoTracker",
      "DeviceId": "Device-1",
      "Position": [
        121.0187617,
        14.5406917
      ],
      "PositionProperties": {
        "jobOrderId": "JobOrder-1"
      },
      "SampleTime": "2026-01-22T06:51:11.07Z",
      "ReceivedTime": "2026-01-22T06:51:13.939Z"
    }
```

    
> [!NOTE] EventBridge
    EventBridge consumes the event from the Tracker or Geofence.
    A rule is setup to send the event to API.
```

